format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: react-native
app:
  envs:
  - WORKDIR: .
    opts:
      is_expand: false
  - ANDROID_PROJECT_LOCATION: android
    opts:
      is_expand: false
  - ANDROID_MODULE: app
    opts:
      is_expand: false
  - IOS_PROJECT_PATH: ios/AvaxWallet.xcworkspace
    opts:
      is_expand: false
  - APP_TITLE: Core Mobile
    opts:
      is_expand: false
workflows:
  _build-android:
    steps:
    - install-missing-android-tools@3:
        inputs:
        - gradlew_path: $ANDROID_PROJECT_LOCATION/gradlew
    - restore-gradle-cache@1: {}
    - android-build@1:
        inputs:
        - project_location: $ANDROID_PROJECT_LOCATION
        - module: $ANDROID_MODULE
        - arguments: :app:assembleInternalE2eAndroidTest
        - build_type: aab
        - cache_level: all
        - variant: $ANDROID_BUILD_VARIANT
    - save-gradle-cache@1: {}
    - sign-apk@1:
        inputs:
        - android_app: $BITRISE_AAB_PATH
        - use_apk_signer: "true"
        - debuggable_permitted: "false"
        - keystore_url: $BITRISEIO_ANDROID_KEY_STORE_URL
        - keystore_password: $ANDROID_STORE_PASSWORD
        - keystore_alias: $ANDROID_KEY_ALIAS
        - private_key_password: $ANDROID_KEY_PASSWORD
    - bitrise-step-export-universal-apk@0:
        inputs:
        - keystore_password: $ANDROID_STORE_PASSWORD
        - keystore_alias: $ANDROID_KEY_ALIAS
        - private_key_password: $ANDROID_KEY_PASSWORD
        - keystore_url: $BITRISEIO_ANDROID_KEY_STORE_URL
  _build-android-for-testing:
    steps:
    - install-missing-android-tools@3:
        inputs:
        - gradlew_path: $ANDROID_PROJECT_LOCATION/gradlew
    - restore-gradle-cache@1: {}
    - script-runner@0:
        title: Fix Android Env Vars
        inputs:
        - file_path: scripts/bitrise/fixAndroidEnvVars.sh
    - avd-manager@1.2:
        inputs:
        - api_level: "28"
        - emulator_id: emulator-5554
        - emulator_channel: "0"
        - create_command_flags: --sdcard 512M
        - tag: default
        - abi: x86_64
        - profile: pixel_4
    - android-build-for-ui-testing@0:
        inputs:
        - module: $ANDROID_MODULE
        - variant: $ANDROID_BUILD_VARIANT
        - cache_level: all
        - project_location: $ANDROID_PROJECT_LOCATION
    - save-gradle-cache@1: {}
    - sign-apk@1:
        inputs:
        - android_app: $BITRISE_APK_PATH|$BITRISE_TEST_APK_PATH
        - use_apk_signer: "true"
        - debuggable_permitted: "false"
        - keystore_url: $BITRISEIO_ANDROID_KEY_STORE_URL
        - keystore_password: $ANDROID_STORE_PASSWORD
        - keystore_alias: $ANDROID_KEY_ALIAS
        - private_key_password: $ANDROID_KEY_PASSWORD
  _build-ios:
    steps:
    - restore-cocoapods-cache@1: {}
    - cocoapods-install@2:
        inputs:
        - verbose: "true"
        - source_root_path: $BITRISE_SOURCE_DIR/ios
    - save-cocoapods-cache@1: {}
    - xcode-archive@4:
        inputs:
        - project_path: $IOS_PROJECT_PATH
        - scheme: $IOS_SCHEME
        - compile_bitcode: "no"
        - configuration: $IOS_CONFIGURATION
        - distribution_method: $XCODE_EXPORT
        - upload_bitcode: "no"
        - automatic_code_signing: api-key
  _build-ios-simulator:
    steps:
    - restore-cocoapods-cache@1: {}
    - cocoapods-install@2:
        inputs:
        - verbose: "true"
        - source_root_path: $BITRISE_SOURCE_DIR/ios
    - save-cocoapods-cache@1: {}
    - xcode-build-for-simulator@0:
        inputs:
        - scheme: $IOS_SCHEME
        - simulator_device: iPhone 13
        - configuration: $IOS_CONFIGURATION
        - project_path: $IOS_PROJECT_PATH
        - code_signing_allowed: "yes"
  _install-and-set-env:
    before_run:
    - _install-node-18
    steps:
    - restore-npm-cache@1: {}
    - script-runner@0:
        title: Yarn Setup
        inputs:
        - file_path: scripts/bitrise/yarnSetup.sh
    - save-npm-cache@1: {}
    - script-runner@0:
        title: Download Env Files
        inputs:
        - file_path: scripts/bitrise/downloadEnvFiles.sh
    - script-runner@0:
        title: Set Env
        inputs:
        - file_path: scripts/bitrise/setEnv.sh
    - script-runner@0:
        title: Override Feature Flags Key
        inputs:
        - file_path: scripts/bitrise/overrideFeatureFlagsKey.sh
  _install-node-18:
    steps:
    - restore-cache@1:
        title: Restore Node 18 Cache
        inputs:
        - key: node-18-{{ .OS }}-{{ .Arch }}
    - nvm@1:
        inputs:
        - node_version: 18.14.1
    - save-cache@1:
        title: Save Node 18 Cache
        inputs:
        - paths: |-
            /Users/vagrant/.nvm/*
            /root/.nvm/*
        - is_key_unique: "true"
        - key: node-18-{{ .OS }}-{{ .Arch }}
  _send-notification-slack:
    steps:
    - slack@3:
        inputs:
        - pretext: '*New $PLATFORM Build Available!*'
        - message: ""
        - fields: |-
            App|${APP_TITLE}
            Platform|${PLATFORM}
            Version|${APP_VERSION}.${BUILD_NUMBER}
            Workflow|${BITRISE_TRIGGERED_WORKFLOW_ID}
            Environment|${ENVIRONMENT}
            Branch|${BITRISE_GIT_BRANCH}
            Commit|${GIT_CLONE_COMMIT_HASH}
        - title_on_error: $GIT_CLONE_COMMIT_MESSAGE_SUBJECT
        - message_on_error: Build Failed
        - icon_url: ""
        - from_username: ""
        - timestamp: "no"
        - color: '#40BA8E'
        - footer_icon: ""
        - from_username_on_error: ""
        - icon_url_on_error: ""
        - buttons: |
            View App|${BITRISE_APP_URL}
            View Build|${BITRISE_BUILD_URL}
            Install|${BITRISE_PUBLIC_INSTALL_PAGE_URL}
        - footer: ""
        - thumb_url: $BITRISE_PUBLIC_INSTALL_PAGE_QR_CODE_IMAGE_URL
        - webhook_url: $SLACK_WEBHOOK_URL
  _send-test-result-notifcation-slack:
    steps:
    - slack@3:
        inputs:
        - pretext: '*New $PLATFORM Test Results Available!*'
        - fields: |-
            App|${APP_TITLE}
            Platform|${PLATFORM}
            Version|${APP_VERSION}.${BUILD_NUMBER}
            Workflow|${BITRISE_TRIGGERED_WORKFLOW_ID}
            Environment|${ENVIRONMENT}
            Branch|${BITRISE_GIT_BRANCH}
            Commit|${GIT_CLONE_COMMIT_HASH}
        - title: ':kirby_dance: <https://media.tenor.com/jxPq6fvRcEwAAAAd/chris-farley-tommy.gif|Tests
            have passed on commit "$GIT_CLONE_COMMIT_MESSAGE_SUBJECT">'
        - title_on_error: ':doom_mad: <https://media.tenor.com/NClbuZnSxSgAAAAC/what-shocked.gif|Tests
            failed on commit "$GIT_CLONE_COMMIT_MESSAGE_SUBJECT">'
        - timestamp: "no"
        - color: '#40BA8E'
        - buttons: |
            View App|${BITRISE_APP_URL}
            View Build|${BITRISE_BUILD_URL}
            View Test Run|https://avalabs.testrail.io/index.php?/runs/view/${TESTRAIL_RUN}&group_by=cases:section_id&group_order=asc
        - webhook_url: $SLACK_TEST_RESULT_WEBHOOK_URL
  _set-version:
    steps:
    - script-runner@0:
        title: Get App Version
        inputs:
        - file_path: scripts/bitrise/getAppVersion.sh
    - script-runner@0:
        title: Get Build Number
        inputs:
        - file_path: scripts/bitrise/getBuildNumber.sh
    - set-ios-info-plist-unified@1:
        title: Set iOS Version
        run_if: '{{enveq "PLATFORM" "iOS"}}'
        inputs:
        - bundle_version: $BUILD_NUMBER
        - bundle_version_short: $APP_VERSION
        - info_plist_file: $BITRISE_SOURCE_DIR/ios/AvaxWallet/InfoRelease.plist
    - change-android-versioncode-and-versionname@1:
        title: Set Android Version
        run_if: '{{enveq "PLATFORM" "Android"}}'
        inputs:
        - new_version_name: $APP_VERSION
        - version_code_offset: ""
        - new_version_code: $BUILD_NUMBER
        - build_gradle_path: $BITRISE_SOURCE_DIR/$ANDROID_PROJECT_LOCATION/app/build.gradle
  android:
    before_run:
    - _install-and-set-env
    - _set-version
    - _build-android
    after_run:
    - _send-notification-slack
    envs:
    - ENVIRONMENT: production
      opts:
        is_expand: false
    - PLATFORM: Android
      opts:
        is_expand: false
    - ANDROID_BUILD_VARIANT: externalRelease
      opts:
        is_expand: false
    steps:
    - deploy-to-bitrise-io@2: {}
    - create-install-page-qr-code@1: {}
    - google-play-deploy@3:
        inputs:
        - package_name: com.avaxwallet
        - app_path: $BITRISE_SIGNED_AAB_PATH
        - track: internal
        - service_account_json_key_path: $BITRISEIO_AVALABS_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_KEY_URL
  android-e2e:
    before_run:
    - _install-and-set-env
    - _set-version
    - _build-android-for-testing
    after_run:
    - _send-test-result-notifcation-slack
    envs:
    - ENVIRONMENT: production
      opts:
        is_expand: false
    - PLATFORM: Android
      opts:
        is_expand: false
    - ANDROID_BUILD_VARIANT: externalE2e
      opts:
        is_expand: false
    - APP_TITLE: Core Mobile
      opts:
        is_expand: false
    - E2E: "true"
      opts:
        is_expand: false
    steps:
    - wait-for-android-emulator@1: {}
    - script-runner@0:
        title: Detox
        inputs:
        - file_path: scripts/bitrise/detox/androidInternalE2e.sh
  android-internal:
    before_run:
    - _install-and-set-env
    - _set-version
    - _build-android
    after_run:
    - _send-notification-slack
    envs:
    - ENVIRONMENT: production
      opts:
        is_expand: false
    - PLATFORM: Android
      opts:
        is_expand: false
    - ANDROID_BUILD_VARIANT: internalRelease
      opts:
        is_expand: false
    - APP_TITLE: Core Mobile Internal
      opts:
        is_expand: false
    - USE_TEST_FEATURE_FLAGS: "true"
      opts:
        is_expand: false
    steps:
    - deploy-to-bitrise-io@2: {}
    - create-install-page-qr-code@1: {}
    - google-play-deploy@3:
        inputs:
        - package_name: com.avaxwallet.internal
        - app_path: $BITRISE_SIGNED_AAB_PATH
        - track: internal
        - service_account_json_key_path: $BITRISEIO_AVALABS_GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_KEY_URL
  android-internal-e2e:
    before_run:
    - _install-and-set-env
    - _set-version
    - _build-android-for-testing
    after_run:
    - _send-test-result-notifcation-slack
    envs:
    - ENVIRONMENT: production
      opts:
        is_expand: false
    - PLATFORM: Android
      opts:
        is_expand: false
    - ANDROID_BUILD_VARIANT: internalE2e
      opts:
        is_expand: false
    - APP_TITLE: Core Mobile Internal
      opts:
        is_expand: false
    - E2E: "true"
      opts:
        is_expand: false
    - USE_TEST_FEATURE_FLAGS: "true"
      opts:
        is_expand: false
    steps:
    - wait-for-android-emulator@1: {}
    - script-runner@0:
        title: Detox
        inputs:
        - file_path: scripts/bitrise/detox/androidInternalE2e.sh
  ios:
    before_run:
    - _install-and-set-env
    - _set-version
    - _build-ios
    after_run:
    - _send-notification-slack
    envs:
    - ENVIRONMENT: production
      opts:
        is_expand: false
    - PLATFORM: iOS
      opts:
        is_expand: false
    - IOS_CONFIGURATION: Release
      opts:
        is_expand: false
    - XCODE_EXPORT: app-store
      opts:
        is_expand: false
    - IOS_SCHEME: AvaxWallet
      opts:
        is_expand: false
    steps:
    - deploy-to-itunesconnect-application-loader@1:
        inputs:
        - api_key_path: $BITRISEIO_APPSTORE_CONNECT_API_KEY_URL
        - altool_options: --verbose
        - connection: api_key
        - api_issuer: $APPSTORE_CONNECT_KEY_ISSUER_ID
  ios-e2e:
    before_run:
    - _install-and-set-env
    - _set-version
    - _build-ios-simulator
    after_run:
    - _send-test-result-notifcation-slack
    envs:
    - ENVIRONMENT: production
      opts:
        is_expand: false
    - PLATFORM: iOS
      opts:
        is_expand: false
    - IOS_CONFIGURATION: Release
      opts:
        is_expand: false
    - IOS_SCHEME: AvaxWallet
      opts:
        is_expand: false
    - APP_TITLE: Core Mobile
      opts:
        is_expand: false
    - E2E: "true"
      opts:
        is_expand: false
    steps:
    - script-runner@0:
        title: Detox
        inputs:
        - file_path: scripts/bitrise/detox/iosE2e.sh
  ios-internal:
    before_run:
    - _install-and-set-env
    - _set-version
    - _build-ios
    after_run:
    - _send-notification-slack
    envs:
    - ENVIRONMENT: production
      opts:
        is_expand: false
    - PLATFORM: iOS
      opts:
        is_expand: false
    - IOS_CONFIGURATION: Release
      opts:
        is_expand: false
    - XCODE_EXPORT: app-store
      opts:
        is_expand: false
    - IOS_SCHEME: AvaxWalletInternal
      opts:
        is_expand: false
    - APP_TITLE: Core Mobile Internal
      opts:
        is_expand: false
    - USE_TEST_FEATURE_FLAGS: "true"
      opts:
        is_expand: false
    steps:
    - deploy-to-itunesconnect-application-loader@1:
        inputs:
        - api_key_path: $BITRISEIO_APPSTORE_CONNECT_API_KEY_URL
        - altool_options: --verbose
        - api_issuer: $APPSTORE_CONNECT_KEY_ISSUER_ID
        - connection: api_key
  ios-internal-e2e:
    before_run:
    - _install-and-set-env
    - _set-version
    - _build-ios-simulator
    after_run:
    - _send-test-result-notifcation-slack
    envs:
    - ENVIRONMENT: production
      opts:
        is_expand: false
    - PLATFORM: iOS
      opts:
        is_expand: false
    - IOS_CONFIGURATION: Release
      opts:
        is_expand: false
    - IOS_SCHEME: AvaxWalletInternal
      opts:
        is_expand: false
    - APP_TITLE: Core Mobile Internal
      opts:
        is_expand: false
    - E2E: "true"
      opts:
        is_expand: false
    - USE_TEST_FEATURE_FLAGS: "true"
      opts:
        is_expand: false
    steps:
    - script-runner@0:
        title: Detox
        inputs:
        - file_path: scripts/bitrise/detox/iosInternalE2e.sh
