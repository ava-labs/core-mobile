#!/usr/bin/env node
/* eslint-disable no-console */

/**
 * This script generates the list of throttled modal routes from the (modals) folder structure.
 * Run this script after adding/removing modal routes to update the generated file.
 *
 * Usage: node scripts/generate-throttled-routes.js
 */

const fs = require('fs')
const path = require('path')

const MODALS_DIR = path.join(__dirname, '../app/new/routes/(signedIn)/(modals)')
const OUTPUT_FILE = path.join(__dirname, '../app/new/common/router/generatedThrottledRoutes.ts')

/**
 * Recursively get all route paths from a directory
 * @param {string} dir - Directory to scan
 * @param {string} prefix - Route prefix
 * @returns {string[]} Array of route paths
 */
function getRoutePaths(dir, prefix = '') {
  const routes = []

  try {
    const entries = fs.readdirSync(dir, { withFileTypes: true })

    for (const entry of entries) {
      if (entry.isDirectory()) {
        const routeName = entry.name
        // Skip internal folders that start with underscore or parentheses (layout groups)
        if (routeName.startsWith('_') || routeName.startsWith('(')) {
          continue
        }

        const routePath = prefix ? `${prefix}/${routeName}` : `/${routeName}`
        routes.push(routePath)

        // Recursively scan subdirectories for nested routes
        const subRoutes = getRoutePaths(path.join(dir, routeName), routePath)
        routes.push(...subRoutes)
      }
    }
  } catch (error) {
    console.error(`Error scanning directory ${dir}:`, error.message)
  }

  return routes
}

function generateThrottledRoutes() {
  console.log('Scanning modals directory:', MODALS_DIR)

  const routes = getRoutePaths(MODALS_DIR)

  // Sort routes alphabetically for consistent output
  routes.sort()

  console.log(`Found ${routes.length} modal routes`)

  const fileContent = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 *
 * This file is generated by scripts/generate-throttled-routes.js
 * Run 'yarn generate:throttled-routes' to regenerate.
 *
 * These are the modal routes that should be throttled to prevent
 * double-tap navigation issues.
 */

export const GENERATED_THROTTLED_ROUTES = [
${routes.map(route => `  '${route}'`).join(',\n')}
] as const

export type ThrottledRoute = typeof GENERATED_THROTTLED_ROUTES[number]
`

  // Ensure directory exists
  const outputDir = path.dirname(OUTPUT_FILE)
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true })
  }

  fs.writeFileSync(OUTPUT_FILE, fileContent, 'utf8')
  console.log(`Generated throttled routes file: ${OUTPUT_FILE}`)
}

generateThrottledRoutes()
